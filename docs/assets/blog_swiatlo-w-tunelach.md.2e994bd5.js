import{_ as p,C as l,o as t,c as r,k as s,a as n,t as o,H as c,w as i,Q as y}from"./chunks/framework.fa3e7808.js";const f=JSON.parse('{"title":"Światło w tunelach","description":"Kolejna infrastruktura, kolejna twierdza nie do zdobycia. Oczko w głowie klienta. Zawiłe procedury aby uzyskać dostęp. I tu pojawia się cały na biało VPN.","frontmatter":{"author":"Jakub Spórna","title":"Światło w tunelach","description":"Kolejna infrastruktura, kolejna twierdza nie do zdobycia. Oczko w głowie klienta. Zawiłe procedury aby uzyskać dostęp. I tu pojawia się cały na biało VPN.","date":"2021-01-12T00:00:00.000Z"},"headers":[],"relativePath":"blog/swiatlo-w-tunelach.md","filePath":"blog/swiatlo-w-tunelach.md"}'),E={name:"blog/swiatlo-w-tunelach.md"},d={id:"frontmatter-title",tabindex:"-1"},u=s("a",{class:"header-anchor",href:"#frontmatter-title","aria-label":'Permalink to "{{ $frontmatter.title }}"'},"​",-1),z=y(`<h2 id="tunel-do-eldorado" tabindex="-1">Tunel do Eldorado <a class="header-anchor" href="#tunel-do-eldorado" aria-label="Permalink to &quot;Tunel do Eldorado&quot;">​</a></h2><p>Dla mnie jako DevOpsa infrastruktura to jak woda dla rybek. Można się pławić we własnym akwarium ucząc się nowych sztuczek czy ćwicząc stare. Ale dostęp do prawdziwych otwartych akwenów to jest &quot;to co tygryski lubią najbardziej&quot;.</p><p>Na szczęście są momenty, że trzeba dostać się do prywatnych i zamkniętych akwenów - to środowiska produkcyjne. Zazwyczaj są pilnie strzeżone, obwarowane procedurami, monitoringiem, oknami serwisowymi - a przynajmniej w teorii. Czasem trzeba mimo wszystko w nim coś naprawić, poprawić, ulepszyć.</p><p>Niejednokrotnie otrzymujemy dostęp do VPNa i musimy dokonfigurować naszą maszynę uzbrajając ją w odpowiednie oprogramowanie zależny od technologi tunelowania. Jeden tunel to nie problem, bo światło na jego końcu jest dobre.</p><p>A co kiedy mamy tych tuneli kilka i mają pracować równocześnie? Dla przykładu:</p><p>⊛ tunel 1 → repozytorium kodu<br> ⊛ tunel 2 → CI/CD<br> ⊛ tunel 3 → środowisko aplikacyjne</p><p>Nadal nie jest źle jak tylko sieci nie nachodzą na siebie i poszczególne tunele nie są dla siebie antagonistami w tym ekosystemie.</p><p>Kiedy jednak nie jest różowo i nie można mieć równocześnie zestawionych tuneli trzeba znaleźć inne rozwiązanie.<br> Oczywiście ile głów tyle pomysłów: dodatkowe interfejsy sieciowe, kolejne warstwy sieci, niezależne maszyny, wirtualizacja...</p><h2 id="mleko-i-miod-w-tunelu" tabindex="-1">Mleko i miód w tunelu <a class="header-anchor" href="#mleko-i-miod-w-tunelu" aria-label="Permalink to &quot;Mleko i miód w tunelu&quot;">​</a></h2><h3 id="łyzka-dziegciu" tabindex="-1">Łyżka dziegciu <a class="header-anchor" href="#łyzka-dziegciu" aria-label="Permalink to &quot;Łyżka dziegciu&quot;">​</a></h3><p>Jak już wspomniałem przy jednym tunelu światło na jego końcu jest dobre. Jednak może się zdarzyć sytuacja, że trafi nam się klient / pracodawca, który chce kontrolować cały ruch osób, które korzystają z VPNa. I w takiej sytuacji wszelkie nasze działania sieciowe mogą podlegać logowaniu i monitorowaniu. Niekoniecznie jesteśmy o tym informowani lub świadomi poziomu kontroli.</p><h3 id="odrobina-słodyczy" tabindex="-1">Odrobina słodyczy <a class="header-anchor" href="#odrobina-słodyczy" aria-label="Permalink to &quot;Odrobina słodyczy&quot;">​</a></h3><p>Czasem dyskusja o rozwiązaniach tworzonych &quot;na kolanie&quot;, ale mających głębszy i zasadny sens, przynosi owoce. I tak dzięki rozmową z <a href="https://github.com/slashbeast" target="_blank" rel="noreferrer">Piotrem</a> powstał projekt wykorzystujący kilka buzz wordów ze stajni DevOps: Vagrant, Ansible, Dante, VPN L2TP+IPsec</p><p><a href="https://github.com/jsporna/vagrant-vpn-l2tp-ipsec-socks5-proxy" target="_blank" rel="noreferrer">https://github.com/jsporna/vagrant-vpn-l2tp-ipsec-socks5-proxy</a></p><p>A ma on na celu tworzenie odizolowanego tunelu VPN - w tym przypadku L2TP+IPsec - w ramach maszyny wirtualnej. Dzięki temu możemy mieć uruchomionych N tuneli VPN na osobnych maszynach wirtualnych i ich wzajemna konfiguracja oraz adresacja nie będą na siebie wpływać. Dodatkowo jako wyizolowany tunel VPN nie będzie obsługiwał całego ruchu z maszyny gospodarza a jedynie ruch jaki zostanie przekierowany na wybraną maszynę wirtualną poprzez SOCKS proxy.</p><h3 id="analiza-statyczna" tabindex="-1">Analiza statyczna <a class="header-anchor" href="#analiza-statyczna" aria-label="Permalink to &quot;Analiza statyczna&quot;">​</a></h3><p>Rozłóżmy to na czynniki pierwsze.</p><p>Wybrana została wirtualizacja, ponieważ pozwala na posiadanie całkowicie odizolowanej warstwy sieciowej od gospodarza w przeciwieństwie od rozwiązania opartego na konteneryzacji - docker. Komunikacja z gospodarzem może odbywać się poprzez NAT albo połączenie mostkowe z wybraną kartą sieciową. Istotne, aby maszyna wirtualna miała wyjście na świat aby utworzyć tunel VPN oraz pozwalała na komunikację z maszyny gospodarza aby móc się dostać do tunelu VPN.</p><p>Do zarządzania maszyną wirtualną zastał wykorzystany <a href="https://www.vagrantup.com/" target="_blank" rel="noreferrer">Hashicorp Vagrant</a>. Pozwala on zapisać definicję maszyny wraz z konfiguracją przy pomocy kodu w pliku <a href="https://github.com/jsporna/vagrant-vpn-l2tp-ipsec-socks5-proxy/blob/main/Vagrantfile" target="_blank" rel="noreferrer">Vagrantfile</a>.</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">Vagrant</span><span style="color:#E1E4E8;">.configure(</span><span style="color:#9ECBFF;">&quot;2&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> |config|</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Vagrant</span><span style="color:#E1E4E8;">.has_plugin?(</span><span style="color:#9ECBFF;">&quot;vagrant-env&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        config.env.</span><span style="color:#79B8FF;">load</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;.env.local&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;.env&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># required</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">VPN_GATEWAY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> default_s(</span><span style="color:#9ECBFF;">&#39;VPN_GATEWAY&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">VPN_IPSEC_PSK</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> default_s(</span><span style="color:#9ECBFF;">&#39;VPN_IPSEC_PSK&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">VPN_USER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> default_s(</span><span style="color:#9ECBFF;">&#39;VPN_USER&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">VPN_PASSWORD</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> default_s(</span><span style="color:#9ECBFF;">&#39;VPN_PASSWORD&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># optional</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">VPN_SOCKS_PORT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> default_i(</span><span style="color:#9ECBFF;">&#39;VPN_SOCKS_PORT&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1080</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">default_s</span><span style="color:#E1E4E8;">(key, default)</span></span>
<span class="line"><span style="color:#79B8FF;">ENV</span><span style="color:#E1E4E8;">[key] </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ENV</span><span style="color:#E1E4E8;">[key].empty? </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ENV</span><span style="color:#E1E4E8;">[key] : default</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">default_i</span><span style="color:#E1E4E8;">(key, default)</span></span>
<span class="line"><span style="color:#E1E4E8;">default_s(key, default).to_i</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#79B8FF;">Vagrant</span><span style="color:#E1E4E8;">.configure(</span><span style="color:#9ECBFF;">&quot;2&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> |config|</span></span>
<span class="line"><span style="color:#E1E4E8;">    config.vm.box </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;bento/ubuntu-20.04&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    config.vm.network </span><span style="color:#9ECBFF;">&quot;forwarded_port&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">guest:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1080</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">host:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">VPN_SOCKS_PORT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    config.vm.provision </span><span style="color:#9ECBFF;">&quot;ansible&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> |ansible|</span></span>
<span class="line"><span style="color:#E1E4E8;">        ansible.playbook </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;playbook.yml&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        ansible.extra_vars </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">vpn_gateway:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">VPN_GATEWAY</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">vpn_ipsec_psk:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">VPN_IPSEC_PSK</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">vpn_user:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">VPN_USER</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">vpn_password:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">VPN_PASSWORD</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">Vagrant</span><span style="color:#24292E;">.configure(</span><span style="color:#032F62;">&quot;2&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> |config|</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Vagrant</span><span style="color:#24292E;">.has_plugin?(</span><span style="color:#032F62;">&quot;vagrant-env&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        config.env.</span><span style="color:#005CC5;">load</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;.env.local&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;.env&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># required</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">VPN_GATEWAY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> default_s(</span><span style="color:#032F62;">&#39;VPN_GATEWAY&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">VPN_IPSEC_PSK</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> default_s(</span><span style="color:#032F62;">&#39;VPN_IPSEC_PSK&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">VPN_USER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> default_s(</span><span style="color:#032F62;">&#39;VPN_USER&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">VPN_PASSWORD</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> default_s(</span><span style="color:#032F62;">&#39;VPN_PASSWORD&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># optional</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">VPN_SOCKS_PORT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> default_i(</span><span style="color:#032F62;">&#39;VPN_SOCKS_PORT&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1080</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">default_s</span><span style="color:#24292E;">(key, default)</span></span>
<span class="line"><span style="color:#005CC5;">ENV</span><span style="color:#24292E;">[key] </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ENV</span><span style="color:#24292E;">[key].empty? </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ENV</span><span style="color:#24292E;">[key] : default</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">default_i</span><span style="color:#24292E;">(key, default)</span></span>
<span class="line"><span style="color:#24292E;">default_s(key, default).to_i</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#005CC5;">Vagrant</span><span style="color:#24292E;">.configure(</span><span style="color:#032F62;">&quot;2&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> |config|</span></span>
<span class="line"><span style="color:#24292E;">    config.vm.box </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;bento/ubuntu-20.04&quot;</span></span>
<span class="line"><span style="color:#24292E;">    config.vm.network </span><span style="color:#032F62;">&quot;forwarded_port&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">guest:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1080</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">host:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">VPN_SOCKS_PORT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    config.vm.provision </span><span style="color:#032F62;">&quot;ansible&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> |ansible|</span></span>
<span class="line"><span style="color:#24292E;">        ansible.playbook </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;playbook.yml&quot;</span></span>
<span class="line"><span style="color:#24292E;">        ansible.extra_vars </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">vpn_gateway:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">VPN_GATEWAY</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">vpn_ipsec_psk:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">VPN_IPSEC_PSK</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">vpn_user:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">VPN_USER</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">vpn_password:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">VPN_PASSWORD</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p>Czy do samej wirtualizacji zostanie użyty <a href="https://www.virtualbox.org/" target="_blank" rel="noreferrer">VirtualBox</a> czy <a href="https://libvirt.org/" target="_blank" rel="noreferrer">libvirt</a> nie ma tu większego znaczenia. W projekcie została wykorzystana dystrybucja <a href="https://app.vagrantup.com/bento/boxes/ubuntu-20.04" target="_blank" rel="noreferrer">Ubuntu 20.04</a> przygotowana przez projekt <a href="https://github.com/chef/bento" target="_blank" rel="noreferrer">bento</a>.</p><p>Szczegółowa konfiguracja krok po kroku została zapisana w kodzie <a href="https://www.ansible.com/" target="_blank" rel="noreferrer">Ansible&#39;a</a> w postaci dedykowanej pod ten projekt <a href="https://github.com/jsporna/vagrant-vpn-l2tp-ipsec-socks5-proxy/tree/main/roles/vpn" target="_blank" rel="noreferrer">roli</a>. Obejmuje on instalacje niezbędnych pakietów, konfiguracje serwisów, konfiguracje tunelu VPN.</p><p>Do zarządzania warstwą sieciową został użyty <a href="https://help.ubuntu.com/community/NetworkManager" target="_blank" rel="noreferrer">NetworkManager</a>.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">install packages</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apt</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">network-manager</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">network-manager-l2tp</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">network-manager-strongswan</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">dante-server</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">net-tools</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">state</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">present</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">update_cache</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">yes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">install packages</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apt</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">network-manager</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">network-manager-l2tp</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">network-manager-strongswan</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">dante-server</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">net-tools</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">state</span><span style="color:#24292E;">: </span><span style="color:#032F62;">present</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">update_cache</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">yes</span></span></code></pre></div><p>Konfiguracja połączeń została zrealizowana poprzez nmcli z poziomu konsoli.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">set up vpn configuration</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">shell</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nmcli c add con-name vpn type vpn vpn-type l2tp vpn.data &quot;gateway={{ vpn_gateway }}, ipsec-enabled=yes, ipsec-psk={{ vpn_ipsec_psk }}, password-flags=0, user={{ vpn_user }}&quot; vpn.secrets password={{ vpn_password }}</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">when</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">vpn_gateway != &quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">vpn_ipsec_psk != &quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">vpn_user != &quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">vpn_password != &quot;&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">set up vpn configuration</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">shell</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nmcli c add con-name vpn type vpn vpn-type l2tp vpn.data &quot;gateway={{ vpn_gateway }}, ipsec-enabled=yes, ipsec-psk={{ vpn_ipsec_psk }}, password-flags=0, user={{ vpn_user }}&quot; vpn.secrets password={{ vpn_password }}</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">when</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">vpn_gateway != &quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">vpn_ipsec_psk != &quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">vpn_user != &quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">vpn_password != &quot;&quot;</span></span></code></pre></div><p>Wisienką na torcie jest dante-server, który pełni rolę SOCKS proxy. Nasłuchując na porcie 1080, przekierowuje ruch do tunelu VPN.</p><div class="language-conf vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">logoutput: /var/log/sockd.log</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">internal: eth0 port = 1080</span></span>
<span class="line"><span style="color:#e1e4e8;">external: ppp0</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">clientmethod: none</span></span>
<span class="line"><span style="color:#e1e4e8;">socksmethod: none</span></span>
<span class="line"><span style="color:#e1e4e8;">user.privileged: root</span></span>
<span class="line"><span style="color:#e1e4e8;">user.unprivileged: nobody</span></span>
<span class="line"><span style="color:#e1e4e8;">timeout.negotiate: 30</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">client pass {</span></span>
<span class="line"><span style="color:#e1e4e8;">  from: 0.0.0.0/0 to: 0.0.0.0/0</span></span>
<span class="line"><span style="color:#e1e4e8;">  log: error # connect disconnect</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">socks pass {</span></span>
<span class="line"><span style="color:#e1e4e8;">  from: 0.0.0.0/0 to: 0.0.0.0/0</span></span>
<span class="line"><span style="color:#e1e4e8;">  log: error # connect disconnect</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">logoutput: /var/log/sockd.log</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">internal: eth0 port = 1080</span></span>
<span class="line"><span style="color:#24292e;">external: ppp0</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">clientmethod: none</span></span>
<span class="line"><span style="color:#24292e;">socksmethod: none</span></span>
<span class="line"><span style="color:#24292e;">user.privileged: root</span></span>
<span class="line"><span style="color:#24292e;">user.unprivileged: nobody</span></span>
<span class="line"><span style="color:#24292e;">timeout.negotiate: 30</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">client pass {</span></span>
<span class="line"><span style="color:#24292e;">  from: 0.0.0.0/0 to: 0.0.0.0/0</span></span>
<span class="line"><span style="color:#24292e;">  log: error # connect disconnect</span></span>
<span class="line"><span style="color:#24292e;">}</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">socks pass {</span></span>
<span class="line"><span style="color:#24292e;">  from: 0.0.0.0/0 to: 0.0.0.0/0</span></span>
<span class="line"><span style="color:#24292e;">  log: error # connect disconnect</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p>Dzięki takiemu podejściu na maszynie gospodarza możemy uruchomić naszą ulubioną przeglądarkę internetową z ustawionym SOCKS proxy aby nasza komunikacja przechodziła przez tunel i pozwalała nam na dostęp do prywatnych zasobów klienta / pracodawcy. Zarazem możemy korzystać z innej instancji przeglądarki, która będzie komunikowała się bezpośrednio ze światem, do celów prywatnych - dostęp do konta bankowego, zakupy online, komunikacja z rodziną i znajomymi.</p><p>To rozwiązanie nie obejmuje wyłącznie przeglądarek internetowych. Każde narzędzie czy aplikacja, która potrafi komunikować się za pośrednictwem SOCKS proxy, może korzystać z tak przygotowanego tunelu. Dla przykładu git i dostęp do repozytorium poprzez tunel VPN:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">git</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clone</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">core.sshCommand=&#39;ssh -o ProxyCommand=&quot;nc -x localhost:1080 %h %p&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">git@git.example.com:private-repo.git</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">git</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clone</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#032F62;">core.sshCommand=&#39;ssh -o ProxyCommand=&quot;nc -x localhost:1080 %h %p&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">git@git.example.com:private-repo.git</span></span></code></pre></div><h2 id="synteza" tabindex="-1">Synteza <a class="header-anchor" href="#synteza" aria-label="Permalink to &quot;Synteza&quot;">​</a></h2><p>Co i jak zostało zrobione jest już omówione to pora na użycie tego w pracy codziennej.</p><p>Aktorzy:</p><ul><li>firefox</li><li>ssh</li><li>git</li></ul><h3 id="firefox" tabindex="-1">Firefox <a class="header-anchor" href="#firefox" aria-label="Permalink to &quot;Firefox&quot;">​</a></h3><p>W przeglądarce tworzymy dedykowany profil → <a href="https://support.mozilla.org/pl/kb/zarzadzanie-profilami" target="_blank" rel="noreferrer">SRC</a><br> W tym profilu konfigurujemy sobie proxy → <a href="https://support.mozilla.org/pl/kb/ustawienia-polaczenia-internetowego" target="_blank" rel="noreferrer">SRC</a></p><p>SOCKS Host to nazwa domenowa lub IP naszej wirtualnej maszyny,<br> Wprowadzamy port na jakim proxy nasłuchuje.<br> SOCKS v5.<br> I co bardzo ważne zaznaczamy &quot;Proxy DNS when using SOCKS v5&quot; aby zapytania DNS też odbywały się przez proxy a co za tym idzie tunel VPN.</p><p>I tak oto mamy przygotowaną przeglądarkę do pracy przez tunel VPN.</p><h3 id="ssh" tabindex="-1">SSH <a class="header-anchor" href="#ssh" aria-label="Permalink to &quot;SSH&quot;">​</a></h3><p>W pliku <strong>~/.ssh/config</strong> możemy zdefiniować sobie pojedyncze hosty lub ich grupy, dla których komunikacja będzie odbywać się przez proxy.</p><div class="language-conf vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">Host 10.20.*</span></span>
<span class="line"><span style="color:#e1e4e8;">    ProxyCommand nc -x localhost:1081 %h %p</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">Host 172.16.*</span></span>
<span class="line"><span style="color:#e1e4e8;">    ProxyCommand nc -x localhost:1080 %h %p</span></span>
<span class="line"><span style="color:#e1e4e8;">    </span></span>
<span class="line"><span style="color:#e1e4e8;">Host 10.10.1.120</span></span>
<span class="line"><span style="color:#e1e4e8;">    ProxyCommand nx -x localhost:1082 %h %p</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">Host 10.20.*</span></span>
<span class="line"><span style="color:#24292e;">    ProxyCommand nc -x localhost:1081 %h %p</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">Host 172.16.*</span></span>
<span class="line"><span style="color:#24292e;">    ProxyCommand nc -x localhost:1080 %h %p</span></span>
<span class="line"><span style="color:#24292e;">    </span></span>
<span class="line"><span style="color:#24292e;">Host 10.10.1.120</span></span>
<span class="line"><span style="color:#24292e;">    ProxyCommand nx -x localhost:1082 %h %p</span></span></code></pre></div><h3 id="git" tabindex="-1">GIT <a class="header-anchor" href="#git" aria-label="Permalink to &quot;GIT&quot;">​</a></h3><p>Jeżeli komunikacja z repozytoriami kodu nie korzysta z SSH to dodatkowo potrzebujemy ustawić proxy.<br> W pliku <strong>~/.gitconfig</strong> dodajemy wpisy:</p><div class="language-conf vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[includeIf &quot;gitdir:~/Projects/clientA/&quot;]</span></span>
<span class="line"><span style="color:#e1e4e8;">        path = ~/Projects/clientA/.gitconfig</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">[includeIf &quot;gitdir:~/Projects/clientB/&quot;]</span></span>
<span class="line"><span style="color:#e1e4e8;">        path = ~/Projects/clientB/.gitconfig</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[includeIf &quot;gitdir:~/Projects/clientA/&quot;]</span></span>
<span class="line"><span style="color:#24292e;">        path = ~/Projects/clientA/.gitconfig</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">[includeIf &quot;gitdir:~/Projects/clientB/&quot;]</span></span>
<span class="line"><span style="color:#24292e;">        path = ~/Projects/clientB/.gitconfig</span></span></code></pre></div><p>co pozwala na wczytywanie dodatkowej konfiguracji w zależności od umiejscowienia lokalnej kopii repozytorium w drzewie katalogów → <a href="https://git-scm.com/docs/git-config#_includes" target="_blank" rel="noreferrer">SRC</a>. Do takiego pliku <strong>~/Projects/clientX/.gitconfig</strong> dopisujemy:</p><div class="language-conf vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[http]</span></span>
<span class="line"><span style="color:#e1e4e8;">        proxy = socks5h://localhost:1080</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[http]</span></span>
<span class="line"><span style="color:#24292e;">        proxy = socks5h://localhost:1080</span></span></code></pre></div><p>a socks5h oznacza, że zapytania DNS są rozwiązywane przez proxy a co za tym idzie tunel VPN.</p><h2 id="po-drugiej-stronie-tunelu" tabindex="-1">Po drugiej stronie tunelu <a class="header-anchor" href="#po-drugiej-stronie-tunelu" aria-label="Permalink to &quot;Po drugiej stronie tunelu&quot;">​</a></h2><p>To oczywiście tylko minimalna konfiguracja, żeby móc pracować z jednym klientem przez tunel VPN. Każde z tych narzędzie możemy dokonfigurować według własnych potrzeb.<br> Przeglądarka może mieć własny zestaw rozszerzeń. SSH dla wybranych hostów lub grup przypisane dedykowane klucze RSA. Konfiguracja gita dodany klucz gpg do podpisywania commitów.</p><p>Listę narzędzii można rozbudowywać według własnych potrzeb jeżeli tylko kolejne obsługuje proxy SOCKSv5.</p><p>Jako, że VMki z tunelem i proxy są bardzo lekkie, równocześnie możemy mieć ich uruchomionych kilka. Ubuntu można zamienić na mniejszą dystrybucję aby rozwiązanie stało się jeszcze lżejsze.</p><p>Gdzieś z tyłu głowy świta mi pomysł postawienie takiego rozwiązania na RaspberryPi i zrobić porównanie wydajności takich tuneli dla Maliny w wersji 1, 2, 3 i 4. Wersji Zero nie biorę pod uwagę, ponieważ nie posiada fizycznego portu ethernet.</p><h2 id="bonus" tabindex="-1">Bonus <a class="header-anchor" href="#bonus" aria-label="Permalink to &quot;Bonus&quot;">​</a></h2><p>W czasie tworzenia tego wpisu przygotowałem również analogiczne rozwiązanie dla <a href="https://www.infradead.org/openconnect/" target="_blank" rel="noreferrer">OpenConnect VPN</a> z konfiguracją domyślną dla <a href="https://www.paloaltonetworks.com/products/globalprotect" target="_blank" rel="noreferrer">PAN GlobalProtect</a>.</p><p><a href="https://github.com/jsporna/vagrant-vpn-openconnect-socks5-proxy" target="_blank" rel="noreferrer">https://github.com/jsporna/vagrant-vpn-openconnect-socks5-proxy</a></p><p>Zastosowanie jest identyczne jak w przypadku tunelu L2TP+IPSec.</p>`,57);function k(a,w,g,m,h,b){const e=l("Quote");return t(),r("div",null,[s("h1",d,[n(o(a.$frontmatter.title)+" ",1),u]),c(e,{author:"Terry Pratchett"},{default:i(()=>[n(" Światło wierzy, że przemieszcza się szybciej od wszystkiego, ale się myli. Nieważne, jak szybko pędzi, zawsze odkrywa, że ciemność dotarła na miejsce wcześniej i już na nie czeka. ")]),_:1}),s("p",null,o(a.$frontmatter.description),1),z])}const C=p(E,[["render",k]]);export{f as __pageData,C as default};
