<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Światło w tunelach | sporna.dev</title>
    <meta name="description" content="Kolejna infrastruktura, kolejna twierdza nie do zdobycia. Oczko w głowie klienta. Zawiłe procedury aby uzyskać dostęp. I tu pojawia się cały na biało VPN.">
    <link rel="preload stylesheet" href="/assets/style.d84cba3f.css" as="style">
    
    <script type="module" src="/assets/app.4a1561a4.js"></script>
    <link rel="modulepreload" href="/assets/chunks/framework.fa3e7808.js">
    <link rel="modulepreload" href="/assets/chunks/theme.05a4749d.js">
    <link rel="modulepreload" href="/assets/blog_swiatlo-w-tunelach.md.2e994bd5.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"dark",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5a346dfe><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5a346dfe data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-a0fd61f4><div class="container" data-v-a0fd61f4><div class="title" data-v-a0fd61f4><div class="VPNavBarTitle" data-v-a0fd61f4 data-v-86d1bed8><a class="title" href="/" data-v-86d1bed8><!--[--><!--]--><!----><!--[-->sporna.dev<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-a0fd61f4><div class="curtain" data-v-a0fd61f4></div><div class="content-body" data-v-a0fd61f4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-a0fd61f4><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-a0fd61f4 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/index.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>O mnie</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/contact.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Kontakt</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/offer.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Oferta</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/blog.html" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>Blog</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-a0fd61f4 data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="true" data-v-e6aabb21 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-a0fd61f4 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/jsporna" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink no-icon" href="https://www.linkedin.com/in/jsporna/" aria-label="linkedin" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-a0fd61f4 data-v-d0bd9dde data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-9c007e85><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-d0bd9dde><div class="item appearance" data-v-d0bd9dde><p class="label" data-v-d0bd9dde>Appearance</p><div class="appearance-action" data-v-d0bd9dde><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="true" data-v-d0bd9dde data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-d0bd9dde><div class="item social-links" data-v-d0bd9dde><div class="VPSocialLinks social-links-list" data-v-d0bd9dde data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/jsporna" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink no-icon" href="https://www.linkedin.com/in/jsporna/" aria-label="linkedin" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-a0fd61f4 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav fixed reached-top" data-v-5a346dfe data-v-79c8c1df><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-79c8c1df data-v-1c15a60a><button data-v-1c15a60a>Return to top</button><!----></div></div><!----><div class="VPContent" id="VPContent" data-v-5a346dfe data-v-669faec9><div class="VPDoc has-aside" data-v-669faec9 data-v-6b87e69f><!--[--><!--]--><div class="container" data-v-6b87e69f><div class="aside" data-v-6b87e69f><div class="aside-curtain" data-v-6b87e69f></div><div class="aside-container" data-v-6b87e69f><div class="aside-content" data-v-6b87e69f><div class="VPDocAside" data-v-6b87e69f data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-d330b1bb><div class="content" data-v-d330b1bb><div class="outline-marker" data-v-d330b1bb></div><div class="outline-title" role="heading" aria-level="2" data-v-d330b1bb>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-d330b1bb><span class="visually-hidden" id="doc-outline-aria-label" data-v-d330b1bb> Table of Contents for current page </span><ul class="root" data-v-d330b1bb data-v-d0ee3533><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6b87e69f><div class="content-container" data-v-6b87e69f><!--[--><!--]--><!----><main class="main" data-v-6b87e69f><div style="position:relative;" class="vp-doc _blog_swiatlo-w-tunelach" data-v-6b87e69f><div><h1 id="frontmatter-title" tabindex="-1">Światło w tunelach <a class="header-anchor" href="#frontmatter-title" aria-label="Permalink to &quot;{{ $frontmatter.title }}&quot;">​</a></h1><div class="quote"><blockquote><!--[--> Światło wierzy, że przemieszcza się szybciej od wszystkiego, ale się myli. Nieważne, jak szybko pędzi, zawsze odkrywa, że ciemność dotarła na miejsce wcześniej i już na nie czeka. <!--]--></blockquote><p>Terry Pratchett</p></div><p>Kolejna infrastruktura, kolejna twierdza nie do zdobycia. Oczko w głowie klienta. Zawiłe procedury aby uzyskać dostęp. I tu pojawia się cały na biało VPN.</p><h2 id="tunel-do-eldorado" tabindex="-1">Tunel do Eldorado <a class="header-anchor" href="#tunel-do-eldorado" aria-label="Permalink to &quot;Tunel do Eldorado&quot;">​</a></h2><p>Dla mnie jako DevOpsa infrastruktura to jak woda dla rybek. Można się pławić we własnym akwarium ucząc się nowych sztuczek czy ćwicząc stare. Ale dostęp do prawdziwych otwartych akwenów to jest &quot;to co tygryski lubią najbardziej&quot;.</p><p>Na szczęście są momenty, że trzeba dostać się do prywatnych i zamkniętych akwenów - to środowiska produkcyjne. Zazwyczaj są pilnie strzeżone, obwarowane procedurami, monitoringiem, oknami serwisowymi - a przynajmniej w teorii. Czasem trzeba mimo wszystko w nim coś naprawić, poprawić, ulepszyć.</p><p>Niejednokrotnie otrzymujemy dostęp do VPNa i musimy dokonfigurować naszą maszynę uzbrajając ją w odpowiednie oprogramowanie zależny od technologi tunelowania. Jeden tunel to nie problem, bo światło na jego końcu jest dobre.</p><p>A co kiedy mamy tych tuneli kilka i mają pracować równocześnie? Dla przykładu:</p><p>⊛ tunel 1 → repozytorium kodu<br> ⊛ tunel 2 → CI/CD<br> ⊛ tunel 3 → środowisko aplikacyjne</p><p>Nadal nie jest źle jak tylko sieci nie nachodzą na siebie i poszczególne tunele nie są dla siebie antagonistami w tym ekosystemie.</p><p>Kiedy jednak nie jest różowo i nie można mieć równocześnie zestawionych tuneli trzeba znaleźć inne rozwiązanie.<br> Oczywiście ile głów tyle pomysłów: dodatkowe interfejsy sieciowe, kolejne warstwy sieci, niezależne maszyny, wirtualizacja...</p><h2 id="mleko-i-miod-w-tunelu" tabindex="-1">Mleko i miód w tunelu <a class="header-anchor" href="#mleko-i-miod-w-tunelu" aria-label="Permalink to &quot;Mleko i miód w tunelu&quot;">​</a></h2><h3 id="łyzka-dziegciu" tabindex="-1">Łyżka dziegciu <a class="header-anchor" href="#łyzka-dziegciu" aria-label="Permalink to &quot;Łyżka dziegciu&quot;">​</a></h3><p>Jak już wspomniałem przy jednym tunelu światło na jego końcu jest dobre. Jednak może się zdarzyć sytuacja, że trafi nam się klient / pracodawca, który chce kontrolować cały ruch osób, które korzystają z VPNa. I w takiej sytuacji wszelkie nasze działania sieciowe mogą podlegać logowaniu i monitorowaniu. Niekoniecznie jesteśmy o tym informowani lub świadomi poziomu kontroli.</p><h3 id="odrobina-słodyczy" tabindex="-1">Odrobina słodyczy <a class="header-anchor" href="#odrobina-słodyczy" aria-label="Permalink to &quot;Odrobina słodyczy&quot;">​</a></h3><p>Czasem dyskusja o rozwiązaniach tworzonych &quot;na kolanie&quot;, ale mających głębszy i zasadny sens, przynosi owoce. I tak dzięki rozmową z <a href="https://github.com/slashbeast" target="_blank" rel="noreferrer">Piotrem</a> powstał projekt wykorzystujący kilka buzz wordów ze stajni DevOps: Vagrant, Ansible, Dante, VPN L2TP+IPsec</p><p><a href="https://github.com/jsporna/vagrant-vpn-l2tp-ipsec-socks5-proxy" target="_blank" rel="noreferrer">https://github.com/jsporna/vagrant-vpn-l2tp-ipsec-socks5-proxy</a></p><p>A ma on na celu tworzenie odizolowanego tunelu VPN - w tym przypadku L2TP+IPsec - w ramach maszyny wirtualnej. Dzięki temu możemy mieć uruchomionych N tuneli VPN na osobnych maszynach wirtualnych i ich wzajemna konfiguracja oraz adresacja nie będą na siebie wpływać. Dodatkowo jako wyizolowany tunel VPN nie będzie obsługiwał całego ruchu z maszyny gospodarza a jedynie ruch jaki zostanie przekierowany na wybraną maszynę wirtualną poprzez SOCKS proxy.</p><h3 id="analiza-statyczna" tabindex="-1">Analiza statyczna <a class="header-anchor" href="#analiza-statyczna" aria-label="Permalink to &quot;Analiza statyczna&quot;">​</a></h3><p>Rozłóżmy to na czynniki pierwsze.</p><p>Wybrana została wirtualizacja, ponieważ pozwala na posiadanie całkowicie odizolowanej warstwy sieciowej od gospodarza w przeciwieństwie od rozwiązania opartego na konteneryzacji - docker. Komunikacja z gospodarzem może odbywać się poprzez NAT albo połączenie mostkowe z wybraną kartą sieciową. Istotne, aby maszyna wirtualna miała wyjście na świat aby utworzyć tunel VPN oraz pozwalała na komunikację z maszyny gospodarza aby móc się dostać do tunelu VPN.</p><p>Do zarządzania maszyną wirtualną zastał wykorzystany <a href="https://www.vagrantup.com/" target="_blank" rel="noreferrer">Hashicorp Vagrant</a>. Pozwala on zapisać definicję maszyny wraz z konfiguracją przy pomocy kodu w pliku <a href="https://github.com/jsporna/vagrant-vpn-l2tp-ipsec-socks5-proxy/blob/main/Vagrantfile" target="_blank" rel="noreferrer">Vagrantfile</a>.</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">Vagrant</span><span style="color:#E1E4E8;">.configure(</span><span style="color:#9ECBFF;">&quot;2&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> |config|</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">Vagrant</span><span style="color:#E1E4E8;">.has_plugin?(</span><span style="color:#9ECBFF;">&quot;vagrant-env&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        config.env.</span><span style="color:#79B8FF;">load</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;.env.local&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;.env&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># required</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">VPN_GATEWAY</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> default_s(</span><span style="color:#9ECBFF;">&#39;VPN_GATEWAY&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">VPN_IPSEC_PSK</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> default_s(</span><span style="color:#9ECBFF;">&#39;VPN_IPSEC_PSK&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">VPN_USER</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> default_s(</span><span style="color:#9ECBFF;">&#39;VPN_USER&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">VPN_PASSWORD</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> default_s(</span><span style="color:#9ECBFF;">&#39;VPN_PASSWORD&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># optional</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">VPN_SOCKS_PORT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> default_i(</span><span style="color:#9ECBFF;">&#39;VPN_SOCKS_PORT&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1080</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">default_s</span><span style="color:#E1E4E8;">(key, default)</span></span>
<span class="line"><span style="color:#79B8FF;">ENV</span><span style="color:#E1E4E8;">[key] </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ENV</span><span style="color:#E1E4E8;">[key].empty? </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">ENV</span><span style="color:#E1E4E8;">[key] : default</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">default_i</span><span style="color:#E1E4E8;">(key, default)</span></span>
<span class="line"><span style="color:#E1E4E8;">default_s(key, default).to_i</span></span>
<span class="line"><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#79B8FF;">Vagrant</span><span style="color:#E1E4E8;">.configure(</span><span style="color:#9ECBFF;">&quot;2&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> |config|</span></span>
<span class="line"><span style="color:#E1E4E8;">    config.vm.box </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;bento/ubuntu-20.04&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    config.vm.network </span><span style="color:#9ECBFF;">&quot;forwarded_port&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">guest:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1080</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">host:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">VPN_SOCKS_PORT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    config.vm.provision </span><span style="color:#9ECBFF;">&quot;ansible&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> |ansible|</span></span>
<span class="line"><span style="color:#E1E4E8;">        ansible.playbook </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;playbook.yml&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        ansible.extra_vars </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">vpn_gateway:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">VPN_GATEWAY</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">vpn_ipsec_psk:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">VPN_IPSEC_PSK</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">vpn_user:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">VPN_USER</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">vpn_password:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">VPN_PASSWORD</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">end</span></span>
<span class="line"><span style="color:#F97583;">end</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">Vagrant</span><span style="color:#24292E;">.configure(</span><span style="color:#032F62;">&quot;2&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> |config|</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">Vagrant</span><span style="color:#24292E;">.has_plugin?(</span><span style="color:#032F62;">&quot;vagrant-env&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        config.env.</span><span style="color:#005CC5;">load</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;.env.local&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;.env&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># required</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">VPN_GATEWAY</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> default_s(</span><span style="color:#032F62;">&#39;VPN_GATEWAY&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">VPN_IPSEC_PSK</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> default_s(</span><span style="color:#032F62;">&#39;VPN_IPSEC_PSK&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">VPN_USER</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> default_s(</span><span style="color:#032F62;">&#39;VPN_USER&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">VPN_PASSWORD</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> default_s(</span><span style="color:#032F62;">&#39;VPN_PASSWORD&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># optional</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">VPN_SOCKS_PORT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> default_i(</span><span style="color:#032F62;">&#39;VPN_SOCKS_PORT&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1080</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">default_s</span><span style="color:#24292E;">(key, default)</span></span>
<span class="line"><span style="color:#005CC5;">ENV</span><span style="color:#24292E;">[key] </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ENV</span><span style="color:#24292E;">[key].empty? </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">ENV</span><span style="color:#24292E;">[key] : default</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">default_i</span><span style="color:#24292E;">(key, default)</span></span>
<span class="line"><span style="color:#24292E;">default_s(key, default).to_i</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#005CC5;">Vagrant</span><span style="color:#24292E;">.configure(</span><span style="color:#032F62;">&quot;2&quot;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> |config|</span></span>
<span class="line"><span style="color:#24292E;">    config.vm.box </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;bento/ubuntu-20.04&quot;</span></span>
<span class="line"><span style="color:#24292E;">    config.vm.network </span><span style="color:#032F62;">&quot;forwarded_port&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">guest:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1080</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">host:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">VPN_SOCKS_PORT</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    config.vm.provision </span><span style="color:#032F62;">&quot;ansible&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> |ansible|</span></span>
<span class="line"><span style="color:#24292E;">        ansible.playbook </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;playbook.yml&quot;</span></span>
<span class="line"><span style="color:#24292E;">        ansible.extra_vars </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">vpn_gateway:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">VPN_GATEWAY</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">vpn_ipsec_psk:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">VPN_IPSEC_PSK</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">vpn_user:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">VPN_USER</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">vpn_password:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">VPN_PASSWORD</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">end</span></span>
<span class="line"><span style="color:#D73A49;">end</span></span></code></pre></div><p>Czy do samej wirtualizacji zostanie użyty <a href="https://www.virtualbox.org/" target="_blank" rel="noreferrer">VirtualBox</a> czy <a href="https://libvirt.org/" target="_blank" rel="noreferrer">libvirt</a> nie ma tu większego znaczenia. W projekcie została wykorzystana dystrybucja <a href="https://app.vagrantup.com/bento/boxes/ubuntu-20.04" target="_blank" rel="noreferrer">Ubuntu 20.04</a> przygotowana przez projekt <a href="https://github.com/chef/bento" target="_blank" rel="noreferrer">bento</a>.</p><p>Szczegółowa konfiguracja krok po kroku została zapisana w kodzie <a href="https://www.ansible.com/" target="_blank" rel="noreferrer">Ansible&#39;a</a> w postaci dedykowanej pod ten projekt <a href="https://github.com/jsporna/vagrant-vpn-l2tp-ipsec-socks5-proxy/tree/main/roles/vpn" target="_blank" rel="noreferrer">roli</a>. Obejmuje on instalacje niezbędnych pakietów, konfiguracje serwisów, konfiguracje tunelu VPN.</p><p>Do zarządzania warstwą sieciową został użyty <a href="https://help.ubuntu.com/community/NetworkManager" target="_blank" rel="noreferrer">NetworkManager</a>.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">install packages</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">apt</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">network-manager</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">network-manager-l2tp</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">network-manager-strongswan</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">dante-server</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">net-tools</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">state</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">present</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">update_cache</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">yes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">install packages</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">apt</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">network-manager</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">network-manager-l2tp</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">network-manager-strongswan</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">dante-server</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">net-tools</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">state</span><span style="color:#24292E;">: </span><span style="color:#032F62;">present</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">update_cache</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">yes</span></span></code></pre></div><p>Konfiguracja połączeń została zrealizowana poprzez nmcli z poziomu konsoli.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">set up vpn configuration</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">shell</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nmcli c add con-name vpn type vpn vpn-type l2tp vpn.data &quot;gateway={{ vpn_gateway }}, ipsec-enabled=yes, ipsec-psk={{ vpn_ipsec_psk }}, password-flags=0, user={{ vpn_user }}&quot; vpn.secrets password={{ vpn_password }}</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">when</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">vpn_gateway != &quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">vpn_ipsec_psk != &quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">vpn_user != &quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#9ECBFF;">vpn_password != &quot;&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">- </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">set up vpn configuration</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">shell</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nmcli c add con-name vpn type vpn vpn-type l2tp vpn.data &quot;gateway={{ vpn_gateway }}, ipsec-enabled=yes, ipsec-psk={{ vpn_ipsec_psk }}, password-flags=0, user={{ vpn_user }}&quot; vpn.secrets password={{ vpn_password }}</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">when</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">vpn_gateway != &quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">vpn_ipsec_psk != &quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">vpn_user != &quot;&quot;</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#032F62;">vpn_password != &quot;&quot;</span></span></code></pre></div><p>Wisienką na torcie jest dante-server, który pełni rolę SOCKS proxy. Nasłuchując na porcie 1080, przekierowuje ruch do tunelu VPN.</p><div class="language-conf vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">logoutput: /var/log/sockd.log</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">internal: eth0 port = 1080</span></span>
<span class="line"><span style="color:#e1e4e8;">external: ppp0</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">clientmethod: none</span></span>
<span class="line"><span style="color:#e1e4e8;">socksmethod: none</span></span>
<span class="line"><span style="color:#e1e4e8;">user.privileged: root</span></span>
<span class="line"><span style="color:#e1e4e8;">user.unprivileged: nobody</span></span>
<span class="line"><span style="color:#e1e4e8;">timeout.negotiate: 30</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">client pass {</span></span>
<span class="line"><span style="color:#e1e4e8;">  from: 0.0.0.0/0 to: 0.0.0.0/0</span></span>
<span class="line"><span style="color:#e1e4e8;">  log: error # connect disconnect</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">socks pass {</span></span>
<span class="line"><span style="color:#e1e4e8;">  from: 0.0.0.0/0 to: 0.0.0.0/0</span></span>
<span class="line"><span style="color:#e1e4e8;">  log: error # connect disconnect</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">logoutput: /var/log/sockd.log</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">internal: eth0 port = 1080</span></span>
<span class="line"><span style="color:#24292e;">external: ppp0</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">clientmethod: none</span></span>
<span class="line"><span style="color:#24292e;">socksmethod: none</span></span>
<span class="line"><span style="color:#24292e;">user.privileged: root</span></span>
<span class="line"><span style="color:#24292e;">user.unprivileged: nobody</span></span>
<span class="line"><span style="color:#24292e;">timeout.negotiate: 30</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">client pass {</span></span>
<span class="line"><span style="color:#24292e;">  from: 0.0.0.0/0 to: 0.0.0.0/0</span></span>
<span class="line"><span style="color:#24292e;">  log: error # connect disconnect</span></span>
<span class="line"><span style="color:#24292e;">}</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">socks pass {</span></span>
<span class="line"><span style="color:#24292e;">  from: 0.0.0.0/0 to: 0.0.0.0/0</span></span>
<span class="line"><span style="color:#24292e;">  log: error # connect disconnect</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><p>Dzięki takiemu podejściu na maszynie gospodarza możemy uruchomić naszą ulubioną przeglądarkę internetową z ustawionym SOCKS proxy aby nasza komunikacja przechodziła przez tunel i pozwalała nam na dostęp do prywatnych zasobów klienta / pracodawcy. Zarazem możemy korzystać z innej instancji przeglądarki, która będzie komunikowała się bezpośrednio ze światem, do celów prywatnych - dostęp do konta bankowego, zakupy online, komunikacja z rodziną i znajomymi.</p><p>To rozwiązanie nie obejmuje wyłącznie przeglądarek internetowych. Każde narzędzie czy aplikacja, która potrafi komunikować się za pośrednictwem SOCKS proxy, może korzystać z tak przygotowanego tunelu. Dla przykładu git i dostęp do repozytorium poprzez tunel VPN:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">git</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">clone</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">core.sshCommand=&#39;ssh -o ProxyCommand=&quot;nc -x localhost:1080 %h %p&quot;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">git@git.example.com:private-repo.git</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">git</span><span style="color:#24292E;"> </span><span style="color:#032F62;">clone</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#032F62;">core.sshCommand=&#39;ssh -o ProxyCommand=&quot;nc -x localhost:1080 %h %p&quot;&#39;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">git@git.example.com:private-repo.git</span></span></code></pre></div><h2 id="synteza" tabindex="-1">Synteza <a class="header-anchor" href="#synteza" aria-label="Permalink to &quot;Synteza&quot;">​</a></h2><p>Co i jak zostało zrobione jest już omówione to pora na użycie tego w pracy codziennej.</p><p>Aktorzy:</p><ul><li>firefox</li><li>ssh</li><li>git</li></ul><h3 id="firefox" tabindex="-1">Firefox <a class="header-anchor" href="#firefox" aria-label="Permalink to &quot;Firefox&quot;">​</a></h3><p>W przeglądarce tworzymy dedykowany profil → <a href="https://support.mozilla.org/pl/kb/zarzadzanie-profilami" target="_blank" rel="noreferrer">SRC</a><br> W tym profilu konfigurujemy sobie proxy → <a href="https://support.mozilla.org/pl/kb/ustawienia-polaczenia-internetowego" target="_blank" rel="noreferrer">SRC</a></p><p>SOCKS Host to nazwa domenowa lub IP naszej wirtualnej maszyny,<br> Wprowadzamy port na jakim proxy nasłuchuje.<br> SOCKS v5.<br> I co bardzo ważne zaznaczamy &quot;Proxy DNS when using SOCKS v5&quot; aby zapytania DNS też odbywały się przez proxy a co za tym idzie tunel VPN.</p><p>I tak oto mamy przygotowaną przeglądarkę do pracy przez tunel VPN.</p><h3 id="ssh" tabindex="-1">SSH <a class="header-anchor" href="#ssh" aria-label="Permalink to &quot;SSH&quot;">​</a></h3><p>W pliku <strong>~/.ssh/config</strong> możemy zdefiniować sobie pojedyncze hosty lub ich grupy, dla których komunikacja będzie odbywać się przez proxy.</p><div class="language-conf vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">Host 10.20.*</span></span>
<span class="line"><span style="color:#e1e4e8;">    ProxyCommand nc -x localhost:1081 %h %p</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">Host 172.16.*</span></span>
<span class="line"><span style="color:#e1e4e8;">    ProxyCommand nc -x localhost:1080 %h %p</span></span>
<span class="line"><span style="color:#e1e4e8;">    </span></span>
<span class="line"><span style="color:#e1e4e8;">Host 10.10.1.120</span></span>
<span class="line"><span style="color:#e1e4e8;">    ProxyCommand nx -x localhost:1082 %h %p</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">Host 10.20.*</span></span>
<span class="line"><span style="color:#24292e;">    ProxyCommand nc -x localhost:1081 %h %p</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">Host 172.16.*</span></span>
<span class="line"><span style="color:#24292e;">    ProxyCommand nc -x localhost:1080 %h %p</span></span>
<span class="line"><span style="color:#24292e;">    </span></span>
<span class="line"><span style="color:#24292e;">Host 10.10.1.120</span></span>
<span class="line"><span style="color:#24292e;">    ProxyCommand nx -x localhost:1082 %h %p</span></span></code></pre></div><h3 id="git" tabindex="-1">GIT <a class="header-anchor" href="#git" aria-label="Permalink to &quot;GIT&quot;">​</a></h3><p>Jeżeli komunikacja z repozytoriami kodu nie korzysta z SSH to dodatkowo potrzebujemy ustawić proxy.<br> W pliku <strong>~/.gitconfig</strong> dodajemy wpisy:</p><div class="language-conf vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[includeIf &quot;gitdir:~/Projects/clientA/&quot;]</span></span>
<span class="line"><span style="color:#e1e4e8;">        path = ~/Projects/clientA/.gitconfig</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">[includeIf &quot;gitdir:~/Projects/clientB/&quot;]</span></span>
<span class="line"><span style="color:#e1e4e8;">        path = ~/Projects/clientB/.gitconfig</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[includeIf &quot;gitdir:~/Projects/clientA/&quot;]</span></span>
<span class="line"><span style="color:#24292e;">        path = ~/Projects/clientA/.gitconfig</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">[includeIf &quot;gitdir:~/Projects/clientB/&quot;]</span></span>
<span class="line"><span style="color:#24292e;">        path = ~/Projects/clientB/.gitconfig</span></span></code></pre></div><p>co pozwala na wczytywanie dodatkowej konfiguracji w zależności od umiejscowienia lokalnej kopii repozytorium w drzewie katalogów → <a href="https://git-scm.com/docs/git-config#_includes" target="_blank" rel="noreferrer">SRC</a>. Do takiego pliku <strong>~/Projects/clientX/.gitconfig</strong> dopisujemy:</p><div class="language-conf vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[http]</span></span>
<span class="line"><span style="color:#e1e4e8;">        proxy = socks5h://localhost:1080</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[http]</span></span>
<span class="line"><span style="color:#24292e;">        proxy = socks5h://localhost:1080</span></span></code></pre></div><p>a socks5h oznacza, że zapytania DNS są rozwiązywane przez proxy a co za tym idzie tunel VPN.</p><h2 id="po-drugiej-stronie-tunelu" tabindex="-1">Po drugiej stronie tunelu <a class="header-anchor" href="#po-drugiej-stronie-tunelu" aria-label="Permalink to &quot;Po drugiej stronie tunelu&quot;">​</a></h2><p>To oczywiście tylko minimalna konfiguracja, żeby móc pracować z jednym klientem przez tunel VPN. Każde z tych narzędzie możemy dokonfigurować według własnych potrzeb.<br> Przeglądarka może mieć własny zestaw rozszerzeń. SSH dla wybranych hostów lub grup przypisane dedykowane klucze RSA. Konfiguracja gita dodany klucz gpg do podpisywania commitów.</p><p>Listę narzędzii można rozbudowywać według własnych potrzeb jeżeli tylko kolejne obsługuje proxy SOCKSv5.</p><p>Jako, że VMki z tunelem i proxy są bardzo lekkie, równocześnie możemy mieć ich uruchomionych kilka. Ubuntu można zamienić na mniejszą dystrybucję aby rozwiązanie stało się jeszcze lżejsze.</p><p>Gdzieś z tyłu głowy świta mi pomysł postawienie takiego rozwiązania na RaspberryPi i zrobić porównanie wydajności takich tuneli dla Maliny w wersji 1, 2, 3 i 4. Wersji Zero nie biorę pod uwagę, ponieważ nie posiada fizycznego portu ethernet.</p><h2 id="bonus" tabindex="-1">Bonus <a class="header-anchor" href="#bonus" aria-label="Permalink to &quot;Bonus&quot;">​</a></h2><p>W czasie tworzenia tego wpisu przygotowałem również analogiczne rozwiązanie dla <a href="https://www.infradead.org/openconnect/" target="_blank" rel="noreferrer">OpenConnect VPN</a> z konfiguracją domyślną dla <a href="https://www.paloaltonetworks.com/products/globalprotect" target="_blank" rel="noreferrer">PAN GlobalProtect</a>.</p><p><a href="https://github.com/jsporna/vagrant-vpn-openconnect-socks5-proxy" target="_blank" rel="noreferrer">https://github.com/jsporna/vagrant-vpn-openconnect-socks5-proxy</a></p><p>Zastosowanie jest identyczne jak w przypadku tunelu L2TP+IPSec.</p></div></div></main><footer class="VPDocFooter" data-v-6b87e69f data-v-ef5dee53><!--[--><!--]--><!----><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"blog_przeszczep-wiedzy.md\":\"b8e951ca\",\"blog.md\":\"db7bd673\",\"index.md\":\"3d9a1df7\",\"contact.md\":\"0a8d9713\",\"offer.md\":\"643e3ca2\",\"blog_swiatlo-w-tunelach.md\":\"2e994bd5\",\"blog_wejscie-do-jamy-smoka.md\":\"20da19bf\",\"blog_waz-w-kieszeni.md\":\"4cf10ffc\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"sporna.dev\",\"description\":\"A VitePress site\",\"base\":\"/\",\"head\":[],\"appearance\":\"dark\",\"themeConfig\":{\"nav\":[{\"text\":\"O mnie\",\"link\":\"/index\",\"activeMatch\":\"/index\"},{\"text\":\"Kontakt\",\"link\":\"/contact\",\"activeMatch\":\"/contact\"},{\"text\":\"Oferta\",\"link\":\"/offer\",\"activeMatch\":\"/offer\"},{\"text\":\"Blog\",\"link\":\"/blog\",\"activeMatch\":\"/blog\"}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/jsporna\"},{\"icon\":\"linkedin\",\"link\":\"https://www.linkedin.com/in/jsporna/\"}],\"outline\":[2,6]},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>